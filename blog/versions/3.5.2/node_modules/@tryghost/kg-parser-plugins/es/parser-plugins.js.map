{"version":3,"file":"parser-plugins.js","sources":["../lib/parser-plugins.js"],"sourcesContent":["/* global DOMParser, window */\n\n/**\n * Copied from:\n * https://github.com/TryGhost/Ghost-Admin/blob/1f3d77d7230dd47a7eb5f38b90dfa510b2a16801/lib/koenig-editor/addon/options/parser-plugins.js\n * Which makes use of:\n * https://github.com/TryGhost/Ghost-Admin/blob/1f3d77d7230dd47a7eb5f38b90dfa510b2a16801/lib/koenig-editor/addon/helpers/clean-basic-html.js\n *\n * These functions are used to proces nodes during parsing from DOM -> mobiledoc\n */\n\nimport cleanBasicHtml from '@tryghost/kg-clean-basic-html';\n\nexport function createParserPlugins(_options = {}) {\n    const defaults = {};\n    const options = Object.assign({}, defaults, _options);\n\n    if (!options.createDocument) {\n        const Parser = (typeof DOMParser !== 'undefined' && DOMParser) || (typeof window !== 'undefined' && window.DOMParser);\n\n        if (!Parser) {\n            throw new Error('createParserPlugins() must be passed a `createDocument` function as an option when used in a non-browser environment');\n        }\n\n        options.createDocument = function (html) {\n            const parser = new Parser();\n            return parser.parseFromString(html, 'text/html');\n        };\n    }\n\n    // HELPERS -----------------------------------------------------------------\n\n    function _readFigCaptionFromNode(node, payload) {\n        let figcaption = node.querySelector('figcaption');\n\n        if (figcaption) {\n            let cleanHtml = cleanBasicHtml(figcaption.innerHTML, options);\n            payload.caption = payload.caption ? `${payload.caption} / ${cleanHtml}` : cleanHtml;\n            figcaption.remove(); // cleanup this processed element\n        }\n    }\n\n    function _readGalleryImageFromNode(node, imgNum) {\n        let fileName = node.src.match(/[^/]*$/)[0];\n        let image = {\n            fileName,\n            row: Math.floor(imgNum / 3),\n            src: node.src\n        };\n\n        if (node.width) {\n            image.width = node.width;\n        } else if (node.dataset && node.dataset.width) {\n            image.width = parseInt(node.dataset.width, 10);\n        }\n\n        if (node.height) {\n            image.height = node.height;\n        } else if (node.dataset && node.dataset.height) {\n            image.height = parseInt(node.dataset.height, 10);\n        }\n\n        if (node.alt) {\n            image.alt = node.alt;\n        }\n\n        if (node.title) {\n            image.title = node.title;\n        }\n\n        return image;\n    }\n\n    // PLUGINS -----------------------------------------------------------------\n\n    function mixtapeEmbed(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'DIV' || !node.className.match(/graf--mixtapeEmbed/)) {\n            return;\n        }\n\n        // Grab the relevant elements - Anchor wraps most of the data\n        let anchorElement = node.querySelector('.markup--mixtapeEmbed-anchor');\n        let titleElement = anchorElement.querySelector('.markup--mixtapeEmbed-strong');\n        let descElement = anchorElement.querySelector('.markup--mixtapeEmbed-em');\n        // Image is a top level field inside it's own a tag\n        let imgElement = node.querySelector('.mixtapeImage');\n\n        // Grab individual values from the elements\n        let url = anchorElement.href;\n        let title = '';\n        let description = '';\n\n        if (titleElement && titleElement.innerHTML) {\n            title = cleanBasicHtml(titleElement.innerHTML, options);\n            // Cleanup anchor so we can see what's left now that we've processed title\n            anchorElement.removeChild(titleElement);\n        }\n\n        if (descElement && descElement.innerHTML) {\n            description = cleanBasicHtml(descElement.innerHTML, options);\n            // Cleanup anchor so we can see what's left now that we've processed description\n            anchorElement.removeChild(descElement);\n        }\n\n        // // Format our preferred structure.\n        let metadata = {\n            url,\n            title,\n            description\n        };\n\n        // Publisher is the remaining text in the anchor, once title & desc are removed\n        let publisher = cleanBasicHtml(anchorElement.innerHTML, options);\n        if (publisher) {\n            metadata.publisher = publisher;\n        }\n\n        // Image is optional,\n        // The element usually still exists with an additional has.mixtapeImage--empty class and has no background image\n        if (imgElement && imgElement.style['background-image']) {\n            metadata.thumbnail = imgElement.style['background-image'].match(/url\\(([^)]*?)\\)/)[1];\n        }\n\n        let payload = {url, metadata};\n        let cardSection = builder.createCardSection('bookmark', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    // https://github.com/TryGhost/Koenig/issues/1\n    // allows arbitrary HTML blocks wrapped in our card comments to be extracted\n    // into a HTML card rather than being put through the normal parse+plugins\n    function kgHtmlCardToCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 8 || node.nodeValue !== 'kg-card-begin: html') {\n            return;\n        }\n\n        let html = [];\n\n        function isHtmlEndComment(node) {\n            return node && node.nodeType === 8 && node.nodeValue === 'kg-card-end: html';\n        }\n\n        let nextNode = node.nextSibling;\n        while (nextNode && !isHtmlEndComment(nextNode)) {\n            let currentNode = nextNode;\n            html.push(currentNode.outerHTML);\n            nextNode = currentNode.nextSibling;\n            // remove nodes as we go so that they don't go through the parser\n            currentNode.remove();\n        }\n\n        let payload = {html: html.join('\\n').trim()};\n        let cardSection = builder.createCardSection('html', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    // mobiledoc by default ignores <BR> tags but we have a custom SoftReturn atom\n    function brToSoftBreakAtom(node, builder, {addMarkerable, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'BR') {\n            return;\n        }\n\n        let softReturn = builder.createAtom('soft-return');\n        addMarkerable(softReturn);\n\n        nodeFinished();\n    }\n\n    // leading newlines in text nodes will add a space to the beginning of the text\n    // which doesn't render correctly if we're replacing <br> with SoftReturn atoms\n    // after parsing text as markdown to html\n    function removeLeadingNewline(node) {\n        if (node.nodeType !== 3 || node.nodeName !== '#text') {\n            return;\n        }\n\n        node.nodeValue = node.nodeValue.replace(/^\\n/, '');\n    }\n\n    const kgGalleryCardToCard = (node, builder, {addSection, nodeFinished}) => {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        if (!node.className.match(/kg-gallery-card/)) {\n            return;\n        }\n\n        let payload = {};\n        let imgs = Array.from(node.querySelectorAll('img'));\n\n        // Process nodes into the payload\n        payload.images = imgs.map(_readGalleryImageFromNode);\n\n        _readFigCaptionFromNode(node, payload);\n\n        let cardSection = builder.createCardSection('gallery', payload);\n        addSection(cardSection);\n        nodeFinished();\n    };\n\n    function grafGalleryToCard(node, builder, {addSection, nodeFinished}) {\n        function isGrafGallery(node) {\n            return node.nodeType === 1 && node.tagName === 'DIV' && node.dataset && node.dataset.paragraphCount && node.querySelectorAll('img').length > 0;\n        }\n\n        if (!isGrafGallery(node)) {\n            return;\n        }\n\n        let payload = {};\n\n        // These galleries exist in multiple divs. Read the images and cation from the first one...\n        let imgs = Array.from(node.querySelectorAll('img'));\n        _readFigCaptionFromNode(node, payload);\n\n        // ...and then iterate over any remaining divs until we run out of matches\n        let nextNode = node.nextSibling;\n        while (nextNode && isGrafGallery(nextNode)) {\n            let currentNode = nextNode;\n            imgs = imgs.concat(Array.from(currentNode.querySelectorAll('img')));\n            _readFigCaptionFromNode(currentNode, payload);\n            nextNode = currentNode.nextSibling;\n            // remove nodes as we go so that they don't go through the parser\n            currentNode.remove();\n        }\n\n        // Process nodes into the payload\n        payload.images = imgs.map(_readGalleryImageFromNode);\n\n        let cardSection = builder.createCardSection('gallery', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function figureToImageCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        let img = node.querySelector('img');\n        let kgClass = node.className.match(/kg-width-(wide|full)/);\n        let grafClass = node.className.match(/graf--layout(FillWidth|OutsetCenter)/);\n\n        if (!img) {\n            return;\n        }\n\n        let payload = {\n            src: img.src,\n            alt: img.alt,\n            title: img.title\n        };\n\n        if (kgClass) {\n            payload.cardWidth = kgClass[1];\n        } else if (grafClass) {\n            payload.cardWidth = grafClass[1] === 'FillWidth' ? 'full' : 'wide';\n        }\n\n        _readFigCaptionFromNode(node, payload);\n\n        let cardSection = builder.createCardSection('image', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function imgToCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'IMG') {\n            return;\n        }\n\n        let payload = {\n            src: node.src,\n            alt: node.alt,\n            title: node.title\n        };\n\n        let cardSection = builder.createCardSection('image', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function hrToCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'HR') {\n            return;\n        }\n\n        let cardSection = builder.createCardSection('hr');\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function figureIframeToEmbedCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        let iframe = node.querySelector('iframe');\n\n        if (!iframe) {\n            return;\n        }\n\n        let src = iframe.src;\n\n        // If we don't have a src, or it's not an absolute URL, we can't handle this\n        if (!src || !src.match(/^https?:\\/\\//i)) {\n            return;\n        }\n\n        let payload = {\n            url: src\n        };\n\n        _readFigCaptionFromNode(node, payload);\n\n        payload.html = iframe.outerHTML;\n\n        let cardSection = builder.createCardSection('embed', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function figureBlockquoteToEmbedCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        let blockquote = node.querySelector('blockquote');\n        let link = node.querySelector('a');\n\n        if (!blockquote || !link) {\n            return;\n        }\n\n        let url = link.href;\n\n        // If we don't have a url, or it's not an absolute URL, we can't handle this\n        if (!url || !url.match(/^https?:\\/\\//i)) {\n            return;\n        }\n\n        let payload = {\n            url: url\n        };\n\n        _readFigCaptionFromNode(node, payload);\n\n        payload.html = node.innerHTML;\n\n        let cardSection = builder.createCardSection('embed', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function figureToCodeCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        let pre = node.querySelector('pre');\n\n        // If this figure doesn't have a pre tag in it\n        if (!pre) {\n            return;\n        }\n\n        let code = pre.querySelector('code');\n        let figcaption = node.querySelector('figcaption');\n\n        // if there's no caption the preCodeToCard plugin will pick it up instead\n        if (!code || !figcaption) {\n            return;\n        }\n\n        let payload = {\n            code: code.textContent\n        };\n\n        _readFigCaptionFromNode(node, payload);\n\n        let preClass = pre.getAttribute('class') || '';\n        let codeClass = code.getAttribute('class') || '';\n        let langRegex = /lang(?:uage)?-(.*?)(?:\\s|$)/i;\n        let languageMatches = preClass.match(langRegex) || codeClass.match(langRegex);\n        if (languageMatches) {\n            payload.language = languageMatches[1].toLowerCase();\n        }\n\n        let cardSection = builder.createCardSection('code', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    function preCodeToCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'PRE') {\n            return;\n        }\n\n        let [codeElement] = node.children;\n\n        if (codeElement && codeElement.tagName === 'CODE') {\n            let payload = {code: codeElement.textContent};\n\n            let preClass = node.getAttribute('class') || '';\n            let codeClass = codeElement.getAttribute('class') || '';\n            let langRegex = /lang(?:uage)?-(.*?)(?:\\s|$)/i;\n            let languageMatches = preClass.match(langRegex) || codeClass.match(langRegex);\n            if (languageMatches) {\n                payload.language = languageMatches[1].toLowerCase();\n            }\n\n            let cardSection = builder.createCardSection('code', payload);\n            addSection(cardSection);\n            nodeFinished();\n        }\n    }\n\n    function figureScriptToHtmlCard(node, builder, {addSection, nodeFinished}) {\n        if (node.nodeType !== 1 || node.tagName !== 'FIGURE') {\n            return;\n        }\n\n        let script = node.querySelector('script');\n\n        if (!script || !script.src.match(/^https:\\/\\/gist\\.github\\.com/)) {\n            return;\n        }\n\n        let payload = {html: script.outerHTML};\n        let cardSection = builder.createCardSection('html', payload);\n        addSection(cardSection);\n        nodeFinished();\n    }\n\n    return [\n        mixtapeEmbed,\n        kgHtmlCardToCard,\n        brToSoftBreakAtom,\n        removeLeadingNewline,\n        kgGalleryCardToCard,\n        figureBlockquoteToEmbedCard, // I think these can contain images\n        grafGalleryToCard,\n        figureToImageCard,\n        imgToCard,\n        hrToCard,\n        figureToCodeCard,\n        preCodeToCard,\n        figureIframeToEmbedCard,\n        figureScriptToHtmlCard\n    ];\n}\n"],"names":["createParserPlugins","_options","defaults","options","Object","assign","createDocument","Parser","DOMParser","window","Error","html","parser","parseFromString","_readFigCaptionFromNode","node","payload","figcaption","querySelector","cleanHtml","cleanBasicHtml","innerHTML","caption","remove","_readGalleryImageFromNode","imgNum","fileName","src","match","image","row","Math","floor","width","dataset","parseInt","height","alt","title","mixtapeEmbed","builder","addSection","nodeFinished","nodeType","tagName","className","anchorElement","titleElement","descElement","imgElement","url","href","description","removeChild","metadata","publisher","style","thumbnail","cardSection","createCardSection","kgHtmlCardToCard","nodeValue","isHtmlEndComment","nextNode","nextSibling","currentNode","push","outerHTML","join","trim","brToSoftBreakAtom","addMarkerable","softReturn","createAtom","removeLeadingNewline","nodeName","replace","kgGalleryCardToCard","imgs","Array","from","querySelectorAll","images","map","grafGalleryToCard","isGrafGallery","paragraphCount","length","concat","figureToImageCard","img","kgClass","grafClass","cardWidth","imgToCard","hrToCard","figureIframeToEmbedCard","iframe","figureBlockquoteToEmbedCard","blockquote","link","figureToCodeCard","pre","code","textContent","preClass","getAttribute","codeClass","langRegex","languageMatches","language","toLowerCase","preCodeToCard","codeElement","children","figureScriptToHtmlCard","script"],"mappings":"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"}